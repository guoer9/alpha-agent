# Alpha Agent å› å­æŒ–æ˜ç³»ç»Ÿ - è¯¦ç»† Pipeline

## ç³»ç»Ÿæ¶æ„æ€»è§ˆ

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                           Alpha Agent å› å­æŒ–æ˜ç³»ç»Ÿ                                    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                                       â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”‚
â”‚   â”‚ 1.æ•°æ®   â”‚    â”‚ 2.RAG    â”‚    â”‚ 3.LLM    â”‚    â”‚ 4.å› å­   â”‚    â”‚ 5.æ¨¡å‹   â”‚      â”‚
â”‚   â”‚   å‡†å¤‡   â”‚ â”€â”€â–¶â”‚   æ£€ç´¢   â”‚ â”€â”€â–¶â”‚   ç”Ÿæˆ   â”‚ â”€â”€â–¶â”‚   è¯„ä¼°   â”‚ â”€â”€â–¶â”‚   å›æµ‹   â”‚      â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â”‚
â”‚        â”‚               â”‚               â”‚               â”‚               â”‚             â”‚
â”‚        â–¼               â–¼               â–¼               â–¼               â–¼             â”‚
â”‚   Qlib Alpha158   Milvuså‘é‡DB   DashScope API   IC/ICIRè®¡ç®—   PortAnaRecord       â”‚
â”‚   158ä¸ªé‡ä»·å› å­    ç›¸ä¼¼å› å­æ£€ç´¢    qwen-plus      å¿«é€Ÿç­›é€‰       å®Œæ•´ç­–ç•¥å›æµ‹         â”‚
â”‚                                                                                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## é˜¶æ®µ 1: æ•°æ®å‡†å¤‡ (Qlib Alpha158)

### 1.1 æ•°æ®æ¥æº
- **æ•°æ®æä¾›**: Qlib (`~/.qlib/qlib_data/cn_data`)
- **è‚¡ç¥¨æ± **: CSI300 æ²ªæ·±300æˆåˆ†è‚¡
- **æ—¶é—´èŒƒå›´**: 2020-01-01 ~ 2023-06-30

### 1.2 æ•°æ®åˆ’åˆ†
```python
segments = {
    'train': ('2020-01-01', '2021-12-31'),  # è®­ç»ƒæœŸ: 2å¹´
    'valid': ('2022-01-01', '2022-06-30'),  # éªŒè¯æœŸ: 6ä¸ªæœˆ
    'test':  ('2022-07-01', '2023-06-30'),  # æµ‹è¯•æœŸ: 1å¹´
}
```

### 1.3 Alpha158 ç‰¹å¾ (158ä¸ªé‡ä»·å› å­)

| ç±»åˆ« | å› å­ç¤ºä¾‹ | æ•°é‡ |
|------|----------|------|
| Kçº¿å½¢æ€ | KMID, KLEN, KUP, KLOW | 10 |
| ä»·æ ¼ç‰¹å¾ | OPEN0, HIGH0, LOW0, CLOSE0 | 15 |
| æ”¶ç›Šç‡ | ROC5, ROC10, ROC20, ROC60 | 20 |
| æ³¢åŠ¨ç‡ | STD5, STD10, STD20, STD60 | 20 |
| æˆäº¤é‡ | VOLUME, VWAP, VMA5, VMA10 | 25 |
| æŠ€æœ¯æŒ‡æ ‡ | MA5, MA10, RSI, MACD, BETA | 68 |

### 1.4 å®é™…æ•°æ®æ ·æœ¬
```
                           KMID      KLEN     KMID2       KUP      KUP2
datetime   instrument                                                  
2020-01-02 SH600000    0.000000  0.015237  0.000000  0.013633  0.894737
           SH600004   -0.002278  0.012528 -0.181822  0.003417  0.272726
           SH600009   -0.018025  0.022975 -0.784531  0.001650  0.071823
```

### 1.5 æ ‡ç­¾å®šä¹‰ (é¢„æµ‹ç›®æ ‡)
```python
# LABEL0 = æœªæ¥2æ—¥æ”¶ç›Šç‡
LABEL0 = Ref($close, -2) / Ref($close, -1) - 1
```

**æ•°æ®è§„æ¨¡**:
- è®­ç»ƒé›†: 145,800 æ¡è®°å½•
- æµ‹è¯•é›†: 72,900 æ¡è®°å½•
- ç‰¹å¾æ•°: 158 ä¸ª

---

## é˜¶æ®µ 2: RAG å› å­æ£€ç´¢

### 2.1 å‘é‡æ•°æ®åº“
- **å­˜å‚¨**: Milvus å‘é‡æ•°æ®åº“
- **ç´¢å¼•**: å› å­ä»£ç  + æè¿°çš„è¯­ä¹‰å‘é‡
- **æ•°é‡**: 1000+ å†å²å› å­

### 2.2 æ£€ç´¢æµç¨‹
```python
from rag.retriever import RAGRetriever

retriever = RAGRetriever(milvus_uri="http://localhost:19530")
similar_factors = retriever.search(
    query="é‡ä»·åŠ¨é‡å› å­",
    top_k=5
)
```

### 2.3 æ£€ç´¢ç»“æœç¤ºä¾‹
```python
[
    {"name": "MACD", "code": "EMA(close, 12) - EMA(close, 26)", "ic": 0.025},
    {"name": "RSI", "code": "100 - 100/(1 + RS)", "ic": 0.018},
    {"name": "MOM10", "code": "close / close.shift(10) - 1", "ic": 0.022},
]
```

---

## é˜¶æ®µ 3: LLM å› å­ç”Ÿæˆ

### 3.1 Prompt ç»„è£…
```python
from prompt.composer import PromptComposer

composer = PromptComposer()
prompt = composer.for_generation(
    theme="é‡ä»·åŠ¨é‡",
    target_ic=0.03,
    rag_factors=similar_factors  # æ¥è‡ª RAG æ£€ç´¢
)
```

### 3.2 Prompt ç»“æ„

**System Prompt (473å­—ç¬¦)**:
```
ä½ æ˜¯ä¸€ä¸ªä¸“ä¸šçš„é‡åŒ–å› å­æŒ–æ˜ä¸“å®¶ (Alpha Miner)ã€‚

## ä½ çš„èƒ½åŠ›
- æ·±å…¥ç†è§£é‡‘èå¸‚åœºå¾®è§‚ç»“æ„å’Œé‡ä»·å…³ç³»
- ç²¾é€šæŠ€æœ¯åˆ†æã€åŸºæœ¬é¢åˆ†æå’Œå¦ç±»æ•°æ®åˆ†æ
- èƒ½å¤Ÿè®¾è®¡å…·æœ‰é¢„æµ‹èƒ½åŠ›çš„ Alpha å› å­
...
```

**User Prompt (1072å­—ç¬¦)**:
```
## æ•°æ®Schemaï¼ˆç¡¬çº¦æŸï¼‰
ä»¥ä¸‹æ˜¯ä½ å¯ä»¥ä½¿ç”¨çš„æ•°æ®å­—æ®µ...

## å‚è€ƒå› å­ï¼ˆè½¯å¼•å¯¼ï¼‰
### MACD (IC=0.0250)
...

## ä»»åŠ¡: ç”Ÿæˆæ–°å› å­
- ä¸»é¢˜: é‡ä»·åŠ¨é‡
- ç›®æ ‡IC: >0.03
```

### 3.3 LLM è°ƒç”¨
```python
import dashscope

response = dashscope.Generation.call(
    model="qwen-plus",
    messages=prompt.to_messages(),
    api_key="sk-xxx"
)

# è§£æç”Ÿæˆçš„å› å­ä»£ç 
factor_code = parse_factor(response.output.text)
```

### 3.4 ç”Ÿæˆç»“æœç¤ºä¾‹
```python
def compute_alpha(df):
    """
    å› å­åç§°: MomentumReversal
    å› å­é€»è¾‘: çŸ­æœŸåŠ¨é‡ä¸é•¿æœŸåè½¬çš„ç»“åˆ
    é¢„æœŸIC: 0.03
    """
    mom5 = df['close'] / df['close'].shift(5) - 1
    mom20 = df['close'] / df['close'].shift(20) - 1
    alpha = mom5 - mom20 * 0.5
    return alpha.rank(pct=True)
```

---

## é˜¶æ®µ 4: å› å­å¿«é€Ÿè¯„ä¼° (IC/ICIR)

### 4.1 æ²™ç®±æ‰§è¡Œ
```python
from core.sandbox import Sandbox
from core.evaluator import FactorEvaluator

# å®‰å…¨æ‰§è¡Œå› å­ä»£ç 
sandbox = Sandbox()
factor_values = sandbox.execute(factor_code, market_data)

# è®¡ç®— IC
evaluator = FactorEvaluator()
result = evaluator.evaluate(factor_values, future_returns)
```

### 4.2 IC è®¡ç®—åŸç†
```python
# IC = Corr(å› å­å€¼, æœªæ¥æ”¶ç›Š)
# æ¯æ—¥è®¡ç®—æˆªé¢ç›¸å…³æ€§ï¼Œç„¶åå–å‡å€¼

ic_series = []
for date in dates:
    factor_today = factor_values.loc[date]
    return_tomorrow = future_returns.loc[date]
    ic = factor_today.corr(return_tomorrow)  # Pearsonç›¸å…³
    ic_series.append(ic)

IC = np.mean(ic_series)
ICIR = IC / np.std(ic_series)
```

### 4.3 è¯„ä¼°æŒ‡æ ‡

| æŒ‡æ ‡ | å«ä¹‰ | ä¼˜ç§€æ ‡å‡† |
|------|------|----------|
| IC | å› å­ä¸æ”¶ç›Šçš„ç›¸å…³æ€§ | > 0.03 |
| ICIR | ICçš„å¤æ™®æ¯”ç‡ | > 0.5 |
| Rank IC | æ’åç›¸å…³æ€§ | > 0.03 |
| Rank ICIR | Rank ICçš„å¤æ™® | > 0.5 |

### 4.4 å®é™…è¯„ä¼°ç»“æœ
```
ğŸ“Š IC åˆ†æç»“æœ:
   IC å‡å€¼:     0.011279
   IC æ ‡å‡†å·®:   0.127823
   ICIR:        0.095112

   Rank IC å‡å€¼:  0.004012
   Rank ICIR:     0.033290

ğŸ“Š IC ç»Ÿè®¡:
   IC > 0 çš„å¤©æ•°: 112 / 243 (46.1%)
   IC æœ€å¤§å€¼: 0.325337
   IC æœ€å°å€¼: -0.328620
```

---

## é˜¶æ®µ 5: æ¨¡å‹è®­ç»ƒä¸é¢„æµ‹

### 5.1 æ”¯æŒçš„æ¨¡å‹

| æ¨¡å‹ | ç±»å‹ | è®­ç»ƒæ—¶é—´ | æè¿° |
|------|------|----------|------|
| LinearModel | çº¿æ€§ | ~0.3s | å²­å›å½’ |
| LGBModel | æ ‘æ¨¡å‹ | ~5s | LightGBM |
| XGBModel | æ ‘æ¨¡å‹ | ~8s | XGBoost |
| CatBoostModel | æ ‘æ¨¡å‹ | ~10s | CatBoost |
| DNNModel | æ·±åº¦å­¦ä¹  | ~60s | å¤šå±‚æ„ŸçŸ¥æœº |
| TabNetModel | æ·±åº¦å­¦ä¹  | ~120s | æ³¨æ„åŠ›æœºåˆ¶ |

### 5.2 è®­ç»ƒæµç¨‹
```python
from qlib.contrib.model.linear import LinearModel

model = LinearModel()
model.fit(dataset)  # åœ¨è®­ç»ƒé›†ä¸Šå­¦ä¹ 

pred = model.predict(dataset)  # åœ¨æµ‹è¯•é›†ä¸Šé¢„æµ‹
```

### 5.3 é¢„æµ‹ç»“æœ
```
ğŸ“Š é¢„æµ‹åˆ†æ•°åˆ†å¸ƒ:
   æœ€å°å€¼: -0.079834
   æœ€å¤§å€¼: 0.101576
   å‡å€¼:   0.000000
   æ ‡å‡†å·®: 0.025

ğŸ”º é¢„æµ‹åˆ†æ•°æœ€é«˜ Top 5 (ä¹°å…¥ä¿¡å·):
   SH688169: 0.101576
   SZ300919: 0.096381
   SZ300454: 0.094318

ğŸ”» é¢„æµ‹åˆ†æ•°æœ€ä½ Bottom 5 (å–å‡ºä¿¡å·):
   SH601169: -0.071985
   SH601857: -0.066248
   SH601236: -0.064628
```

---

## é˜¶æ®µ 6: ç­–ç•¥å›æµ‹

### 6.1 ç­–ç•¥é…ç½®
```python
strategy_config = {
    'class': 'TopkDropoutStrategy',
    'kwargs': {
        'signal': pred,      # æ¨¡å‹é¢„æµ‹åˆ†æ•°
        'topk': 30,          # æŒä»“30åªè‚¡ç¥¨
        'n_drop': 5,         # æ¯æ—¥å–å‡º5åªæœ€å·®çš„
    }
}

backtest_config = {
    'start_time': '2022-07-01',
    'end_time': '2023-06-30',
    'account': 100000000,    # 1äº¿åˆå§‹èµ„é‡‘
    'benchmark': 'SH000300', # æ²ªæ·±300åŸºå‡†
    'open_cost': 0.0005,     # ä¹°å…¥æˆæœ¬ 0.05%
    'close_cost': 0.0015,    # å–å‡ºæˆæœ¬ 0.15%
}
```

### 6.2 å›æµ‹æ‰§è¡Œ
```python
from qlib.workflow.record_temp import PortAnaRecord

par = PortAnaRecord(recorder, {'strategy': strategy_config, 'backtest': backtest_config})
par.generate()

# åŠ è½½ç»“æœ
report = recorder.load_object('portfolio_analysis/report_normal_1day.pkl')
analysis = recorder.load_object('portfolio_analysis/port_analysis_1day.pkl')
```

### 6.3 æ¯æ—¥äº¤æ˜“è®°å½•
```
                 account        return  turnover     bench
2022-07-01  1.000000e+08  0.000000e+00  0.000000 -0.004078
2022-07-04  9.995259e+07  0.000000e+00  0.948126  0.006562
2022-07-05  9.926981e+07 -0.006494     0.357661 -0.001444
2022-07-06  9.818163e+07 -0.010642     0.320697 -0.014605
2022-07-07  9.941866e+07  0.012925     0.325548  0.004408
```

### 6.4 ç»©æ•ˆæŒ‡æ ‡

| æŒ‡æ ‡ | ä¸å«æˆæœ¬ | å«æˆæœ¬ |
|------|----------|--------|
| å¹´åŒ–è¶…é¢æ”¶ç›Š | 5.35% | -2.34% |
| ä¿¡æ¯æ¯”ç‡ | 0.501 | -0.219 |
| æœ€å¤§å›æ’¤ | 6.21% | 10.26% |

```
ğŸ“ˆ ç´¯è®¡æ”¶ç›Š (å›æµ‹æœŸé—´):
   ç­–ç•¥ç´¯è®¡æ”¶ç›Š: -10.08%
   åŸºå‡†ç´¯è®¡æ”¶ç›Š: -14.33%
   è¶…é¢æ”¶ç›Š:     +4.24%
```

---

## æ··åˆè¿›åŒ–å¼•æ“ (HybridEvolutionEngine)

### æ•´åˆæµç¨‹
```python
from evolution.hybrid_engine import HybridEvolutionEngine

engine = HybridEvolutionEngine(
    llm_generator=llm_gen,
    evaluator=evaluator,
    rag_retriever=retriever
)

# è¿è¡Œè¿›åŒ–
best_factors = engine.run(
    n_rounds=5,
    factors_per_round=20
)
```

### è¿›åŒ–ç­–ç•¥
```
Round 1: LLM ç”Ÿæˆ 20 ä¸ªå› å­
    â†“
å¿«é€Ÿè¯„ä¼° (IC/ICIR) â†’ ç­›é€‰ Top 5
    â†“
Round 2: GP å¯¹ Top 5 è¿›è¡Œå˜å¼‚/äº¤å‰
    â†“
è¯„ä¼°æ–°å› å­ â†’ ç­›é€‰ Top 5
    â†“
Round 3: LLM åæ€å¤±è´¥å› å­ â†’ ç”Ÿæˆæ”¹è¿›ç‰ˆ
    â†“
... (å¾ªç¯)
    â†“
æœ€ç»ˆ: å¯¹ Top å› å­è¿›è¡Œå®Œæ•´æ¨¡å‹å›æµ‹
```

---

## ä¸¤é˜¶æ®µè¯„ä¼°ç­–ç•¥

| é˜¶æ®µ | æ–¹æ³• | è€—æ—¶ | æŒ‡æ ‡ | ç›®çš„ |
|------|------|------|------|------|
| **å¿«é€Ÿç­›é€‰** | ç›´æ¥è®¡ç®— IC | ~1s/å› å­ | IC, ICIR, Rank_IC | è¿‡æ»¤ 80% åŠ£è´¨å› å­ |
| **å®Œæ•´å›æµ‹** | æ¨¡å‹è®­ç»ƒ+ç­–ç•¥å›æµ‹ | ~40s/æ¨¡å‹ | å¹´åŒ–æ”¶ç›Š, IR, æœ€å¤§å›æ’¤ | éªŒè¯ Top å› å­ |

---

## ç›®å½•ç»“æ„

```
alpha_agent/
â”œâ”€â”€ agents/              # LLM ä»£ç†
â”‚   â”œâ”€â”€ mining_agent.py  # å› å­æŒ–æ˜ä»£ç†
â”‚   â””â”€â”€ analysis_agent.py # åˆ†æä»£ç†
â”‚
â”œâ”€â”€ prompt/              # æç¤ºè¯ç³»ç»Ÿ
â”‚   â”œâ”€â”€ composer.py      # Prompt ç»„è£…å™¨
â”‚   â””â”€â”€ templates.py     # æç¤ºè¯æ¨¡æ¿
â”‚
â”œâ”€â”€ rag/                 # RAG æ£€ç´¢
â”‚   â”œâ”€â”€ retriever.py     # å‘é‡æ£€ç´¢
â”‚   â””â”€â”€ indexer.py       # å› å­ç´¢å¼•
â”‚
â”œâ”€â”€ core/                # æ ¸å¿ƒè¯„ä¼°
â”‚   â”œâ”€â”€ evaluator.py     # å› å­è¯„ä¼°å™¨
â”‚   â””â”€â”€ sandbox.py       # å®‰å…¨æ²™ç®±
â”‚
â”œâ”€â”€ evolution/           # è¿›åŒ–å¼•æ“
â”‚   â””â”€â”€ hybrid_engine.py # LLM + GP æ··åˆè¿›åŒ–
â”‚
â”œâ”€â”€ modeling/            # æ¨¡å‹å›æµ‹
â”‚   â”œâ”€â”€ qlib_model_zoo.py # Qlib å¤šæ¨¡å‹åŸºå‡†
â”‚   â””â”€â”€ ensemble.py      # æ¨¡å‹é›†æˆ
â”‚
â”œâ”€â”€ config/              # é…ç½®
â”‚   â””â”€â”€ settings.py      # API Key, è·¯å¾„ç­‰
â”‚
â”œâ”€â”€ output/              # è¾“å‡º
â”‚   â”œâ”€â”€ factors/         # ç”Ÿæˆçš„å› å­
â”‚   â”œâ”€â”€ models/          # æ¨¡å‹ç»“æœ
â”‚   â””â”€â”€ logs/            # æ—¥å¿—
â”‚
â””â”€â”€ run_factor_mining.py # å…¥å£è„šæœ¬
```

---

## è¿è¡Œç¤ºä¾‹

```bash
cd alpha_agent

# è¿è¡Œå› å­æŒ–æ˜
python run_factor_mining.py --rounds 5 --factors_per_round 20

# å•ç‹¬è¿è¡Œæ¨¡å‹å›æµ‹
python -c "
from modeling.qlib_model_zoo import QlibBenchmark
benchmark = QlibBenchmark(models=['linear', 'lgbm'])
results = benchmark.run(
    instruments='csi300',
    train_period=('2020-01-01', '2021-12-31'),
    test_period=('2022-07-01', '2023-06-30')
)
print(results)
"
```

---

## é˜¶æ®µ 7: å› å­ç­›é€‰ç³»ç»Ÿ (NEW)

### 7.1 ç³»ç»Ÿæ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     æ™ºèƒ½å› å­ç­›é€‰ Pipeline                                 â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”‚
â”‚  â”‚ Stage 1  â”‚ â†’  â”‚ Stage 2  â”‚ â†’  â”‚ Stage 3  â”‚ â†’  â”‚ Stage 4  â”‚         â”‚
â”‚  â”‚ å¿«é€ŸIC   â”‚    â”‚ è¯­ä¹‰å»é‡ â”‚    â”‚ èšç±»ä»£è¡¨ â”‚    â”‚ å®Œæ•´è¯„ä¼° â”‚         â”‚
â”‚  â”‚ (é‡‡æ ·)   â”‚    â”‚ (Milvus) â”‚    â”‚ (KMeans) â”‚    â”‚ (IC/ICIR)â”‚         â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â”‚
â”‚       â”‚               â”‚               â”‚               â”‚                â”‚
â”‚       â–¼               â–¼               â–¼               â–¼                â”‚
â”‚   æ·˜æ±°IC<1%      å»é™¤ç›¸ä¼¼>92%     æ¯ç°‡Top3       é˜ˆå€¼ç­›é€‰              â”‚
â”‚                                                       â”‚                â”‚
â”‚                                              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”      â”‚
â”‚                                              â”‚     Stage 5     â”‚      â”‚
â”‚                                              â”‚ æ­£äº¤åŒ–ç»„åˆä¼˜åŒ–   â”‚      â”‚
â”‚                                              â”‚ (ç›¸å…³æ€§<0.7)    â”‚      â”‚
â”‚                                              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â”‚
â”‚                                                       â”‚                â”‚
â”‚                                                       â–¼                â”‚
â”‚                                              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”‚
â”‚                                              â”‚ Qlib æ¨¡å‹å›æµ‹    â”‚      â”‚
â”‚                                              â”‚ (LGB/XGB/Cat)   â”‚      â”‚
â”‚                                              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â”‚
â”‚                                                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 7.2 æ ¸å¿ƒç®—æ³•

**æ­£äº¤åŒ–è´ªå©ªé€‰æ‹© (Greedy Forward Selection)**:
```python
# æ ¸å¿ƒæ€æƒ³: æ¯æ¬¡æ·»åŠ çš„å› å­å¿…é¡»ä¸å·²é€‰å› å­ä½ç›¸å…³

selected = []
for factor in sorted(factors, key=lambda f: abs(f.ic), reverse=True):
    # 1. æ£€æŸ¥ç›¸å…³æ€§çº¦æŸ
    max_corr = max(|corr(factor, s)| for s in selected)
    if max_corr > 0.7:
        continue  # è·³è¿‡é«˜ç›¸å…³å› å­
    
    # 2. æ£€æŸ¥è¾¹é™…ICè´¡çŒ® (æ­£äº¤åŒ–)
    residual = factor - regression(factor, selected)  # å›å½’æ®‹å·®
    marginal_ic = corr(residual, target)
    if marginal_ic < 0.003:
        continue  # è¾¹é™…è´¡çŒ®ä¸è¶³
    
    selected.append(factor)
    if len(selected) >= max_factors:
        break
```

### 7.3 ä½¿ç”¨æ–¹æ³•

```bash
# ä»å› å­åº“ç­›é€‰
python run_factor_selection.py --source library --max-factors 30

# ä»è¿›åŒ–ç»“æœç­›é€‰
python run_factor_selection.py --source evolution --corr-threshold 0.7

# ä½¿ç”¨æ¨¡æ‹Ÿæ•°æ®æµ‹è¯•
python run_factor_selection.py --mock-data --max-factors 20
```

### 7.4 ä»£ç è°ƒç”¨

```python
from alpha_agent.selection import select_factors, FactorSelector

# æ–¹å¼1: ä¾¿æ·å‡½æ•°
result = select_factors(
    candidates=factor_candidates,
    data=qlib_data,
    target=returns,
    max_factors=30,
    corr_threshold=0.7,
)

print(f"é€‰ä¸­ {result.final_count} ä¸ªå› å­")
for f in result.selected_factors:
    print(f"  - {f['name']}: IC={f['ic']:.4f}")

# æ–¹å¼2: å®Œæ•´é…ç½®
selector = FactorSelector(
    quick_ic_threshold=0.01,    # Stage 1: å¿«é€ŸICé˜ˆå€¼
    dedup_threshold=0.92,       # Stage 2: å»é‡é˜ˆå€¼
    n_clusters=20,              # Stage 3: èšç±»æ•°
    max_factors=30,             # Stage 5: æœ€å¤§å› å­æ•°
    corr_threshold=0.7,         # Stage 5: ç›¸å…³æ€§é˜ˆå€¼
    min_marginal_ic=0.003,      # Stage 5: æœ€å°è¾¹é™…IC
)

result = selector.select(factors, data, target, sandbox_executor)
```

### 7.5 è¾“å‡ºæ–‡ä»¶

| æ–‡ä»¶ | å†…å®¹ |
|------|------|
| `selected_factors_*.json` | ç­›é€‰åçš„å› å­åˆ—è¡¨ |
| `correlation_matrix_*.csv` | å› å­ç›¸å…³æ€§çŸ©é˜µ |
| `qlib_factors_*.yaml` | Qlibé…ç½®æ–‡ä»¶ |

### 7.6 ä¸ç°æœ‰ç³»ç»Ÿé›†æˆ

```
                                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                                    â”‚ run_factor_     â”‚
                                    â”‚ mining.py       â”‚
                                    â”‚ (LLM+GPç”Ÿæˆ)    â”‚
                                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                             â”‚
                                             â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ FactorLibrary   â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶  â”‚ run_factor_     â”‚
â”‚ (ç»å…¸å› å­åº“)    â”‚              â”‚ selection.py    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜              â”‚ (æ™ºèƒ½ç­›é€‰)      â”‚
                                 â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                       â”‚
â”‚ Milvus          â”‚ â—€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ (å‘é‡å»é‡)      â”‚                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                       â–¼
                                 â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                                 â”‚ Qlib Model Zoo  â”‚
                                 â”‚ (å¤šæ¨¡å‹å›æµ‹)    â”‚
                                 â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## å®Œæ•´å·¥ä½œæµç¨‹

```bash
# Step 1: å› å­æŒ–æ˜ (LLM + GP)
python run_factor_mining.py --rounds 5

# Step 2: å› å­ç­›é€‰ (æ™ºèƒ½ç­›é€‰)
python run_factor_selection.py --source evolution --max-factors 30

# Step 3: æŸ¥çœ‹ç­›é€‰ç»“æœ
cat output/selection/selected_factors_*.json

# Step 4: ä½¿ç”¨ç­›é€‰åçš„å› å­è¿›è¡ŒQlibå›æµ‹
python -c "
from modeling.qlib_model_zoo import QlibBenchmark
# åŠ è½½ç­›é€‰åçš„å› å­é…ç½®
benchmark = QlibBenchmark(
    config_path='output/selection/qlib_factors_*.yaml',
    models=['lgb', 'xgb', 'catboost']
)
results = benchmark.run()
"
```
