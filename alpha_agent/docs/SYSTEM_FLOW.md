# Alpha Agent 完整系统流程

> 各组件如何协作形成完整的智能因子挖掘系统
> 
> 最后更新: 2024-12-05 | 版本: v0.7.0

## 核心模块概览

| 模块 | 功能 | 关键文件 |
|------|------|----------|
| **混合进化引擎** | LLM+GP三阶段因子生成 | `evolution/hybrid_engine.py` |
| **11模型回测** | 多模型并行验证 | `modeling/qlib_model_zoo.py` |
| **完整指标体系** | IC/夏普/回撤等 | `evaluation/metrics.py` |
| **GraphRAG** | 因子知识图谱 | `graph/` |
| **RAPTOR** | 层次化摘要检索 | `raptor/` |
| **数据字典** | A股字段定义 | `schema/cn_stock_schema.py` |

## 1. 系统全景图

```
┌────────────────────────────────────────────────────────────────────────────────┐
│                              用户输入                                           │
│                    "生成一个低换手的动量因子"                                    │
└────────────────────────────────────────────────────────────────────────────────┘
                                      │
                                      ▼
┌────────────────────────────────────────────────────────────────────────────────┐
│                           1. 上下文构建层                                       │
│  ┌──────────────┐    ┌──────────────┐    ┌──────────────┐                     │
│  │  DataSchema  │    │   RAPTOR     │    │  GraphRAG    │                     │
│  │  数据字典    │    │  层次检索    │    │  关系检索    │                     │
│  │              │    │              │    │              │                     │
│  │ 告诉LLM:    │    │ 告诉LLM:    │    │ 告诉LLM:    │                     │
│  │ "有哪些数据" │    │ "同类因子概况"│    │ "历史失败教训"│                     │
│  └──────┬───────┘    └──────┬───────┘    └──────┬───────┘                     │
│         │                   │                   │                             │
│         └───────────────────┼───────────────────┘                             │
│                             ▼                                                  │
│                    ┌────────────────┐                                         │
│                    │  组装Prompt    │                                         │
│                    │  完整上下文    │                                         │
│                    └───────┬────────┘                                         │
└────────────────────────────┼───────────────────────────────────────────────────┘
                             │
                             ▼
┌────────────────────────────────────────────────────────────────────────────────┐
│                           2. 混合进化生成层 (LLM + GP)                          │
│                                                                                │
│    ┌─────────────────────────────────────────────────────────────────────┐    │
│    │                   Hybrid Evolution Engine                            │    │
│    │                                                                      │    │
│    │   ┌────────────────────────────────────────────────────────────┐    │    │
│    │   │ Phase 1: LLM探索 (创意阶段)                                │    │    │
│    │   │   LLM生成10个/轮 → 快速回测 → IC>1.5%? → 种子库(Top20)    │    │    │
│    │   └────────────────────────────────────────────────────────────┘    │    │
│    │                              ↓ 有效种子                              │    │
│    │   ┌────────────────────────────────────────────────────────────┐    │    │
│    │   │ Phase 2: GP精炼 (优化阶段)                                 │    │    │
│    │   │   种子扩展50个 → 变异/交叉 → 回测 → 精英选择 → 迭代10代   │    │    │
│    │   └────────────────────────────────────────────────────────────┘    │    │
│    │                              ↓ GP优胜者                              │    │
│    │   ┌────────────────────────────────────────────────────────────┐    │    │
│    │   │ Phase 3: LLM反思 (解释阶段)                                │    │    │
│    │   │   Top5 GP优胜 → LLM解释为什么有效 → 最终因子(带逻辑)       │    │    │
│    │   └────────────────────────────────────────────────────────────┘    │    │
│    │                                                                      │    │
│    └─────────────────────────────────────────────────────────────────────┘    │
│                                                                                │
└────────────────────────────────────────────────────────────────────────────────┘
                             │
                             ▼
┌────────────────────────────────────────────────────────────────────────────────┐
│                           3. 知识沉淀层                                         │
│                                                                                │
│    ┌─────────────────┐              ┌─────────────────┐                       │
│    │    GraphRAG     │              │     RAPTOR      │                       │
│    │    存储关系     │              │    更新摘要     │                       │
│    │                 │              │                 │                       │
│    │ - 因子节点      │              │ - 新因子加入L0  │                       │
│    │ - 反思节点      │              │ - 聚类更新L1   │                       │
│    │ - 失败/成功边   │              │ - 摘要更新L2   │                       │
│    └─────────────────┘              └─────────────────┘                       │
│                                                                                │
└────────────────────────────────────────────────────────────────────────────────┘
                             │
                             ▼
┌────────────────────────────────────────────────────────────────────────────────┐
│                              输出结果                                           │
│                    最优因子 + 进化历史 + 使用建议                               │
└────────────────────────────────────────────────────────────────────────────────┘
```

---

## 2. 详细流程分解

### Phase 1: 上下文构建

```
用户输入: "生成一个低换手的动量因子"
                │
                ▼
┌───────────────────────────────────────────────────────────────┐
│                    意图解析                                    │
│   提取: concept="动量", constraint="低换手"                    │
└───────────────────────────────────────────────────────────────┘
                │
        ┌───────┼───────┐
        │       │       │
        ▼       ▼       ▼
┌─────────┐ ┌─────────┐ ┌─────────┐
│DataSchema│ │ RAPTOR │ │GraphRAG │
└────┬────┘ └────┬────┘ └────┬────┘
     │           │           │
     ▼           ▼           ▼
┌─────────────────────────────────────────────────────────────────┐
│                                                                 │
│  数据字典上下文:                                                 │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │ ## 可用数据字段                                          │   │
│  │ - close: 收盘价(复权)，用于计算收益率                     │   │
│  │ - returns: 日收益率，涨跌停±10%                          │   │
│  │ - turnover: 换手率，典型值0.5%-10%                       │   │
│  │ ⚠️ 注意: 使用复权价格，避免除权跳空                       │   │
│  └─────────────────────────────────────────────────────────┘   │
│                                                                 │
│  RAPTOR上下文 (Level 2 摘要):                                   │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │ ## 动量策略整体分析                                       │   │
│  │ - 短期动量(5-10日): IC高但换手率普遍>60%                 │   │
│  │ - 中期动量(20-60日): 换手率可控在30-40%                  │   │
│  │ - 建议: 要低换手，用20日以上窗口                         │   │
│  └─────────────────────────────────────────────────────────┘   │
│                                                                 │
│  GraphRAG上下文 (历史经验):                                     │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │ ## 历史失败教训                                          │   │
│  │ 1. 5日动量因子_v1 换手率达120%                           │   │
│  │    原因: 每日信号变化大                                   │   │
│  │    建议: 添加信号平滑或设置调仓阈值                       │   │
│  │                                                          │   │
│  │ 2. 高频动量因子 在2020年3月亏损35%                       │   │
│  │    原因: 极端行情下动量反转                               │   │
│  │    建议: 添加波动率过滤                                   │   │
│  │                                                          │   │
│  │ ## 成功案例                                              │   │
│  │ - 平滑动量因子: 使用EMA平滑，换手率降至25%               │   │
│  └─────────────────────────────────────────────────────────┘   │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
                │
                ▼
┌─────────────────────────────────────────────────────────────────┐
│                      组装完整Prompt                              │
│                                                                 │
│  # 任务                                                         │
│  生成一个低换手的动量因子                                        │
│                                                                 │
│  # 数据字典                                                      │
│  {data_schema_context}                                          │
│                                                                 │
│  # 同类策略概况 (来自RAPTOR)                                     │
│  {raptor_context}                                               │
│                                                                 │
│  # 历史经验教训 (来自GraphRAG)                                   │
│  {graphrag_context}                                             │
│                                                                 │
│  # 特别注意                                                      │
│  - 根据历史经验，避免使用5日以下窗口                             │
│  - 建议添加信号平滑机制                                          │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

### Phase 2: 混合进化生成 (LLM + GP 协作)

**设计理念**:
- **LLM负责"创意"** - 生成有投资逻辑的种子因子
- **GP负责"优化"** - 在有效种子基础上高效搜索参数空间
- **LLM负责"解释"** - 提炼GP发现的规律，生成可解释因子

```
┌─────────────────────────────────────────────────────────────────┐
│              Phase 1: LLM探索 (创意阶段)                        │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  LLM负责: "有没有" - 探索可能有效的因子方向                     │
│                                                                 │
│  Round 1:                                                       │
│  ┌─────────┐ ┌─────────┐ ┌─────────┐ ┌─────────┐              │
│  │Factor 1 │ │Factor 2 │ │Factor 3 │ │...共10个│              │
│  │20日动量 │ │量价背离 │ │EMA动量  │ │         │              │
│  └────┬────┘ └────┬────┘ └────┬────┘ └────┬────┘              │
│       │           │           │           │                    │
│       └───────────┴───────────┴───────────┘                    │
│                       │                                         │
│                       ▼                                         │
│              ┌────────────────┐                                 │
│              │   快速回测     │                                 │
│              │   筛选 IC>1.5% │                                 │
│              └───────┬────────┘                                 │
│                      │                                          │
│                      ▼                                          │
│  ┌──────────────────────────────────────────────────────────┐  │
│  │ 筛选结果:                                                 │  │
│  │ ✓ Factor 1: IC=0.022 → 进入种子库                        │  │
│  │ ✗ Factor 2: IC=0.008 → 淘汰                              │  │
│  │ ✓ Factor 3: IC=0.031 → 进入种子库 ⭐                     │  │
│  │ ...                                                       │  │
│  └──────────────────────────────────────────────────────────┘  │
│                      │                                          │
│                      ▼                                          │
│  Round 2, 3...: LLM继续生成，反馈已有种子避免重复               │
│                      │                                          │
│                      ▼                                          │
│              ┌────────────────┐                                 │
│              │   种子库       │                                 │
│              │   Top 20 因子  │                                 │
│              │   (IC>1.5%)    │                                 │
│              └───────┬────────┘                                 │
│                                                                 │
│  关键: LLM只需找到"有效方向"，不追求完美                        │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
                      │
                      ▼ 种子因子
┌─────────────────────────────────────────────────────────────────┐
│              Phase 2: GP精炼 (优化阶段)                         │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  GP负责: "好不好" - 在有效空间内高效搜索最优参数                │
│                                                                 │
│  初始化: 从种子扩展为50个群体                                    │
│  ┌──────────────────────────────────────────────────────────┐  │
│  │ 种子因子: momentum = close.pct_change(20)                 │  │
│  │                                                           │  │
│  │ GP变异生成:                                               │  │
│  │ ├─ 变体1: close.pct_change(15)     # 参数调整            │  │
│  │ ├─ 变体2: close.pct_change(25)     # 参数调整            │  │
│  │ ├─ 变体3: rank(close.pct_change(20))  # 添加rank        │  │
│  │ ├─ 变体4: -close.pct_change(20)    # 取反               │  │
│  │ └─ ...共50个                                              │  │
│  └──────────────────────────────────────────────────────────┘  │
│                      │                                          │
│                      ▼                                          │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │                  GP进化循环                              │   │
│  │                                                          │   │
│  │  Generation 0:                                           │   │
│  │    评估50个 → 选Top10%精英 → 记录最优IC=0.031            │   │
│  │                      │                                   │   │
│  │                      ▼                                   │   │
│  │  Generation 1:                                           │   │
│  │    精英交叉/变异 → 新种群50个 → 评估 → 最优IC=0.038     │   │
│  │                      │                                   │   │
│  │                      ▼                                   │   │
│  │  Generation 2-9: 继续迭代...                             │   │
│  │                      │                                   │   │
│  │                      ▼                                   │   │
│  │  Generation 10:                                          │   │
│  │    最优IC=0.048, 收敛 → 输出Top5 GP优胜者                │   │
│  │                                                          │   │
│  └─────────────────────────────────────────────────────────┘   │
│                      │                                          │
│                      ▼                                          │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │              GP优胜者完整回测验证                        │   │
│  │                                                          │   │
│  │  Top5 GP优胜者 → 完整回测 (非快速筛选)                   │   │
│  │                                                          │   │
│  │  回测指标体系:                                           │   │
│  │  ┌─────────────────────────────────────────────────────┐ │   │
│  │  │ 预测能力指标:                                       │ │   │
│  │  │   IC        - Pearson相关系数均值                   │ │   │
│  │  │   ICIR      - IC信息比 (IC_mean/IC_std)             │ │   │
│  │  │   Rank IC   - Spearman秩相关均值                    │ │   │
│  │  │   Rank ICIR - Rank IC信息比                         │ │   │
│  │  │                                                     │ │   │
│  │  │ 等级评定:                                           │ │   │
│  │  │   IC等级   - A/B/C/D/F (基于Rank IC)                │ │   │
│  │  │   ICIR等级 - A/B/C/D/F (基于Rank ICIR)              │ │   │
│  │  │                                                     │ │   │
│  │  │ 收益风险指标:                                       │ │   │
│  │  │   年化收益 (Annualized Return)                      │ │   │
│  │  │   信息比 (Information Ratio)                        │ │   │
│  │  │   最大回撤 (Max Drawdown)                           │ │   │
│  │  │   换手率 (Turnover)                                 │ │   │
│  │  └─────────────────────────────────────────────────────┘ │   │
│  │                                                          │   │
│  │  筛选条件:                                               │   │
│  │  ├─ IC > 2%                                             │   │
│  │  ├─ ICIR > 0.5                                          │   │
│  │  ├─ Rank IC > 2.5%                                      │   │
│  │  ├─ 换手率 < 50%                                        │   │
│  │  └─ 最大回撤 < 30%                                      │   │
│  │                                                          │   │
│  └─────────────────────────────────────────────────────────┘   │
│                      │                                          │
│                      ▼                                          │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │              ML模型回测验证 (完整Qlib流程)               │   │
│  │                                                          │   │
│  │  Qlib标准回测流程:                                       │   │
│  │  ┌─────────────────────────────────────────────────────┐ │   │
│  │  │ Step 1: 因子工程                                    │ │   │
│  │  │   新因子 + Alpha158基础特征 → 特征矩阵              │ │   │
│  │  │                                                     │ │   │
│  │  │ Step 2: ML模型训练                                  │ │   │
│  │  │   支持模型: LightGBM / XGBoost / CatBoost /        │ │   │
│  │  │            LSTM / GRU / TabNet                      │ │   │
│  │  │   训练期: 2018-2021, 测试期: 2022-2023             │ │   │
│  │  │                                                     │ │   │
│  │  │ Step 3: 预测生成                                    │ │   │
│  │  │   model.predict() → score (每日每股票)             │ │   │
│  │  │                                                     │ │   │
│  │  │ Step 4: 策略回测                                    │ │   │
│  │  │   TopK策略: 持有Top50, 每日剔除5只                  │ │   │
│  │  │   交易成本: 买入0.05%, 卖出0.15%                    │ │   │
│  │  │                                                     │ │   │
│  │  │ Step 5: 风险分析                                    │ │   │
│  │  │   IC/ICIR, 夏普比率, 最大回撤, 年化收益             │ │   │
│  │  └─────────────────────────────────────────────────────┘ │   │
│  │                                                          │   │
│  │  ML回测通过条件:                                         │   │
│  │  ├─ 夏普比率 > 1.0                                      │   │
│  │  ├─ 最大回撤 < 25%                                      │   │
│  │  └─ 年化收益 > 基准 + 5%                                │   │
│  │                                                          │   │
│  └─────────────────────────────────────────────────────────┘   │
│                      │                                          │
│  优势: GP可以在1分钟内评估数百个参数组合                        │
│        ML模型可捕捉复杂非线性关系                               │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
                      │
                      ▼ 验证通过的GP优胜者
┌─────────────────────────────────────────────────────────────────┐
│              Phase 3: LLM反思 (解释阶段)                        │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  LLM负责: "为什么" - 解释GP发现的规律                           │
│                                                                 │
│  ┌──────────────────────────────────────────────────────────┐  │
│  │ GP优胜者 #1:                                              │  │
│  │ Code: rank(close.pct_change(17).ewm(3).mean())           │  │
│  │ IC: 0.048, ICIR: 1.8                                      │  │
│  │                                                           │  │
│  │ LLM分析:                                                  │  │
│  │ ┌────────────────────────────────────────────────────┐   │  │
│  │ │ ## 因子逻辑解释                                     │   │  │
│  │ │                                                     │   │  │
│  │ │ 该因子捕捉了"平滑中期动量"的市场规律:               │   │  │
│  │ │ 1. 17日窗口 - 接近月度周期，避免噪声               │   │  │
│  │ │ 2. EMA(3)平滑 - 减少日间波动，降低换手             │   │  │
│  │ │ 3. Rank归一化 - 消除量纲，增强截面可比性           │   │  │
│  │ │                                                     │   │  │
│  │ │ 投资逻辑: 趋势跟随 + 信号平滑 = 低换手动量策略     │   │  │
│  │ └────────────────────────────────────────────────────┘   │  │
│  └──────────────────────────────────────────────────────────┘  │
│                      │                                          │
│                      ▼                                          │
│              ┌────────────────┐                                 │
│              │   最终输出     │                                 │
│              │ 可解释的高质量 │                                 │
│              │ Alpha因子      │                                 │
│              └────────────────┘                                 │
│                                                                 │
│  价值: GP找到的因子有效但难以理解                               │
│        LLM赋予其投资逻辑，便于后续改进和复用                    │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

**为什么采用混合策略?**

| 问题 | 纯LLM | 纯GP | **混合策略** |
|------|-------|------|-------------|
| 探索效率 | 低 (token昂贵) | 高 | LLM定方向，GP搜参数 |
| 因子质量 | 有逻辑但不一定最优 | 数值最优但无逻辑 | **既最优又可解释** |
| 计算成本 | 高 (API调用) | 中 (本地计算) | 合理分工 |
| 冷启动 | 可以 | 需要种子 | LLM提供种子 |
| 陷入局部最优 | 可能 | 容易 | LLM反思+随机探索 |

### Phase 3: 知识沉淀

```
┌─────────────────────────────────────────────────────────────────┐
│                      知识沉淀                                    │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  最终因子 + 进化历史 → 存入知识库                               │
│                                                                 │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │                    GraphRAG 更新                         │   │
│  │                                                          │   │
│  │  新增节点:                                               │   │
│  │  [Factor: 平滑动量_v2]                                   │   │
│  │      │                                                   │   │
│  │      ├──(BELONGS_TO)──→ [Concept: 动量策略]             │   │
│  │      │                                                   │   │
│  │      ├──(DERIVED_FROM)──→ [Factor: EMA动量]             │   │
│  │      │                                                   │   │
│  │      ├──(SUCCEEDED_IN)──→ [Regime: 低波动上涨]          │   │
│  │      │                                                   │   │
│  │      ├──(HAS_REFLECTION)──→ [Reflection: 通过添加        │   │
│  │      │                       波动率调整提升夏普...]       │   │
│  │      │                                                   │   │
│  │      └──(CORRELATES_WITH, 0.65)──→ [Factor: 20日动量]   │   │
│  │                                                          │   │
│  └─────────────────────────────────────────────────────────┘   │
│                                                                 │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │                    RAPTOR 更新                           │   │
│  │                                                          │   │
│  │  Level 0: 添加新因子                                     │   │
│  │     └─ [平滑动量_v2] 加入因子库                          │   │
│  │                                                          │   │
│  │  Level 1: 更新因子组                                     │   │
│  │     └─ "中期动量因子组" 重新聚类                         │   │
│  │        新摘要: "新增平滑动量_v2，组内平均IC提升至0.04"   │   │
│  │                                                          │   │
│  │  Level 2: 更新类别摘要                                   │   │
│  │     └─ "动量策略" 摘要更新                               │   │
│  │        "低换手动量的最佳实践: 20日窗口+EMA平滑"          │   │
│  │                                                          │   │
│  └─────────────────────────────────────────────────────────┘   │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

---

## 3. 组件协作关系图

```
                    ┌─────────────────────────────────────────┐
                    │              用户请求                    │
                    └────────────────────┬────────────────────┘
                                         │
                                         ▼
┌────────────────────────────────────────────────────────────────────────────┐
│                              Orchestrator                                   │
│                              (协调中心)                                      │
└─────────┬──────────────────────┬────────────────────────┬──────────────────┘
          │                      │                        │
          │ 1.查询数据字典       │ 2.检索历史经验          │ 3.检索类别摘要
          │                      │                        │
          ▼                      ▼                        ▼
┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐
│   DataSchema    │    │    GraphRAG     │    │     RAPTOR      │
│                 │    │                 │    │                 │
│ to_llm_prompt() │    │  retrieve()     │    │  retrieve()     │
│                 │    │  - 失败案例     │    │  - Level2摘要   │
│ 返回:           │    │  - 成功案例     │    │  - Level1因子组 │
│ 字段+约束+示例  │    │  - 相似因子     │    │                 │
└────────┬────────┘    └────────┬────────┘    └────────┬────────┘
         │                      │                      │
         └──────────────────────┼──────────────────────┘
                                │
                                ▼
                    ┌─────────────────────┐
                    │    Prompt Builder   │
                    │    组装完整上下文   │
                    └──────────┬──────────┘
                               │
                               ▼
┌────────────────────────────────────────────────────────────────────────────┐
│                      Hybrid Evolution Engine (LLM + GP)                    │
│  ┌─────────────────────────────────────────────────────────────────────┐  │
│  │                                                                      │  │
│  │  Phase 1: LLM探索                                                   │  │
│  │    ┌──────────┐      ┌──────────┐      ┌──────────┐                │  │
│  │    │   LLM    │ ───► │ Sandbox  │ ───► │Evaluator │                │  │
│  │    │ 生成种子 │      │ 安全执行 │      │ IC筛选   │                │  │
│  │    └──────────┘      └──────────┘      └────┬─────┘                │  │
│  │                                              │ IC>1.5%              │  │
│  │                                              ▼                      │  │
│  │  Phase 2: GP精炼                      ┌──────────────┐             │  │
│  │    ┌──────────┐                       │   种子库     │             │  │
│  │    │    GP    │ ◄─────────────────────│   Top 20     │             │  │
│  │    │ 变异/交叉│                       └──────────────┘             │  │
│  │    └────┬─────┘                                                     │  │
│  │         │ 迭代10代                                                  │  │
│  │         ▼                                                           │  │
│  │  Phase 3: LLM反思                                                   │  │
│  │    ┌──────────┐      ┌──────────┐                                  │  │
│  │    │   LLM    │ ◄─── │GP优胜者  │                                  │  │
│  │    │ 解释逻辑 │      │  Top 5   │                                  │  │
│  │    └──────────┘      └──────────┘                                  │  │
│  │                                                                      │  │
│  └─────────────────────────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────────────────────────┘
                               │
                               │ 最终结果
                               ▼
         ┌─────────────────────┴─────────────────────┐
         │                                           │
         ▼                                           ▼
┌─────────────────┐                        ┌─────────────────┐
│    GraphRAG     │                        │     RAPTOR      │
│   存储新知识    │                        │   更新摘要      │
│                 │                        │                 │
│ add_factor()    │                        │ add_factor()    │
│ add_reflection()│                        │ update_summary()│
└─────────────────┘                        └─────────────────┘
```

---

## 4. 数据流详解

### 4.1 检索阶段数据流

```python
# 伪代码展示数据流

def build_context(user_request: str) -> str:
    """构建LLM上下文"""
    
    # 1. 解析意图
    intent = parse_intent(user_request)
    # → {concept: "动量", constraints: ["低换手"], ...}
    
    # 2. 数据字典
    data_context = data_schema.to_llm_prompt()
    # → "## 可用字段\n- close: 收盘价...\n- turnover: 换手率..."
    
    # 3. RAPTOR检索 (层次化)
    raptor_context = raptor.retrieve(
        query=user_request,
        strategy="top_down"
    )
    # → Level2: "动量策略整体分析..."
    # → Level1: "中期动量因子组: 换手率可控..."
    
    # 4. GraphRAG检索 (关系)
    graph_context = graph_rag.retrieve(
        concept=intent['concept'],
        constraints=intent['constraints']
    )
    # → 失败案例: "5日动量换手率120%..."
    # → 成功案例: "平滑动量换手率25%..."
    # → 改进路径: "添加EMA平滑..."
    
    # 5. 组装Prompt
    prompt = PROMPT_TEMPLATE.format(
        task=user_request,
        data_schema=data_context,
        category_analysis=raptor_context,
        historical_lessons=graph_context,
    )
    
    return prompt
```

### 4.2 进化阶段数据流

```python
def evolution_loop(prompt: str, data: DataFrame) -> List[Factor]:
    """进化主循环"""
    
    # Gen 0: 初始化
    population = llm.generate_variants(prompt, n=16)
    
    for gen in range(MAX_GENERATIONS):
        # 评估
        for individual in population:
            # Sandbox执行
            factor_values = sandbox.execute(individual.code, data)
            
            # Evaluator评分
            metrics = evaluator.evaluate(factor_values, returns)
            # → {ic: 0.04, sharpe: 1.5, turnover: 0.3, ...}
            
            # 计算适应度
            individual.fitness = compute_fitness(metrics)
            
            # 生成诊断报告
            individual.reflection = generate_reflection(metrics)
            # → "⚠️ 夏普偏低，建议添加波动率调整..."
        
        # 选择精英
        elites = select_elites(population, k=4)
        
        # 生成后代 (精英 + 诊断 → LLM改进)
        offspring = generate_offspring(elites)
        
        # 随机注入
        random_individuals = inject_random(n=2)
        
        # 组成新种群
        population = elites + offspring + random_individuals
        
        # 检查终止
        if should_terminate(population):
            break
    
    return get_best(population)
```

### 4.3 沉淀阶段数据流

```python
def store_knowledge(best_factor: Factor, history: EvolutionHistory):
    """知识沉淀"""
    
    # GraphRAG存储
    graph_rag.add_factor(
        factor=best_factor,
        metrics=best_factor.metrics,
    )
    
    graph_rag.add_reflection(
        factor_id=best_factor.id,
        reflection=best_factor.reflection,
    )
    
    # 添加进化关系
    for parent_id in best_factor.parent_ids:
        graph_rag.add_edge(
            from_id=best_factor.id,
            to_id=parent_id,
            relation="DERIVED_FROM",
        )
    
    # RAPTOR更新
    raptor.add_factor(best_factor)
    
    # 定期重建摘要
    if should_rebuild_raptor():
        raptor.rebuild()
```

---

## 5. 关键接口定义

```python
# ============ 数据字典 ============
class DataSchema:
    def to_llm_prompt(self) -> str:
        """生成LLM可读的数据描述"""
        
    def validate(self, df: DataFrame) -> ValidationResult:
        """验证数据质量"""


# ============ RAPTOR ============
class RaptorTree:
    def retrieve(self, query: str, strategy: str = "top_down") -> str:
        """层次化检索，返回相关摘要"""
        
    def add_factor(self, factor: Factor) -> None:
        """添加新因子到L0"""
        
    def rebuild(self) -> None:
        """重建整棵树（定期执行）"""


# ============ GraphRAG ============
class GraphRAG:
    def retrieve(self, concept: str, constraints: List[str]) -> str:
        """检索相关经验"""
        
    def add_factor(self, factor: Factor, metrics: dict) -> None:
        """添加因子节点和关系"""
        
    def add_reflection(self, factor_id: str, reflection: str) -> None:
        """添加反思节点"""


# ============ Evolution ============
class EvolutionEngine:
    def run(self, task: str, data: DataFrame, context: dict) -> EvolutionResult:
        """运行进化流程"""


# ============ Evaluator ============
class DetailedEvaluator:
    def evaluate(self, factor: Series, returns: Series) -> DetailedMetrics:
        """详细评估"""
        
    def generate_reflection(self, metrics: DetailedMetrics) -> str:
        """生成诊断报告"""


# ============ Orchestrator ============
class Orchestrator:
    def run(self, user_request: str) -> OrchestrationResult:
        """完整流程编排"""
        # 1. build_context()
        # 2. evolution.run()
        # 3. store_knowledge()
        # 4. return result
```

---

## 6. 总结: 各组件的角色

| 组件 | 角色 | 输入 | 输出 |
|------|------|------|------|
| **DataSchema** | 数据合同 | 数据定义 | LLM可读的数据描述 |
| **RAPTOR** | 层次记忆 | 用户查询 | 类别摘要、因子组概况 |
| **GraphRAG** | 关系记忆 | 概念+约束 | 历史经验、失败教训、成功案例 |
| **Evolution** | 核心引擎 | 上下文+数据 | 最优因子+进化历史 |
| **Evaluator** | 评判官 | 因子值 | 指标+诊断报告 |
| **Orchestrator** | 指挥官 | 用户请求 | 完整结果 |

**核心理念**: 让LLM基于**数据事实**和**历史经验**说话，而不是凭空想象。

---

*文档版本: v1.0 | 更新时间: 2024-12-05*
